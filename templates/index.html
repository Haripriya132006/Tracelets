<!DOCTYPE html>
<html>
<head>
  <title>Tracelet Maps</title>
  <style>
    canvas {
      border: 2px solid #444;
      margin-top: 20px;
      max-width: 90%;
      height: auto;
    }
  </style>
</head>
<body>
  <h2>Select a Map</h2>
  <form id="mapForm" action="/shortest-path" method="get">
    <select name="map" id="mapSelect" required>
      <option value="Saveetha Engineering College">Saveetha Engineering College (Built-in)</option>
      {% for m in uploaded_maps %}
      <option value="{{ m.map_name }}">{{ m.map_name }}</option>
      {% endfor %}
    </select>
    <br><br>
    <input type="text" name="start" id="startInput" placeholder="Enter start or click on map" required>
    <input type="text" name="goal" id="goalInput" placeholder="Enter destination or click on map" required>
    <button type="submit">Find Path</button>
  </form>

  <hr>
  <h3>Upload a new map</h3>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="text" name="map_name" placeholder="Enter map name (optional)">
    <input type="file" name="file" accept=".jpg,.jpeg,.png,.webp,.img" required>
    <button type="submit">Upload</button>
  </form>
<h2>External Map Path Finder</h2>

<label>Select uploaded map:</label>
<select id="externalMapSelect"></select>

<br><br>

<label>Start (x,y):</label>
<input type="text" id="extStart" placeholder="e.g. 124,432">

<label>End (x,y):</label>
<input type="text" id="extEnd" placeholder="e.g. 560,265">

<button onclick="findExternalPath()">Find Path</button>

<br><br>

<img id="externalHighlighted" style="max-width:90%; border:1px solid #aaa;">

  <canvas id="mapCanvas"></canvas>

  <script>
    const canvas = document.getElementById("mapCanvas");
    const ctx = canvas.getContext("2d");
    let image = new Image();
    let clickCount = 0;

    document.getElementById("mapSelect").addEventListener("change", async (e) => {
      const selectedMap = e.target.value;
      clickCount = 0;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (selectedMap !== "Saveetha Engineering College") {
        image.src = `/map-image/${selectedMap}`;
        image.onload = () => {
          canvas.width = image.width;
          canvas.height = image.height;
          ctx.drawImage(image, 0, 0);
        };
      } else {
        canvas.width = 0;
        canvas.height = 0;
      }
    });

    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (clickCount === 0) {
        ctx.fillStyle = "green";
        document.getElementById("startInput").value = `${x.toFixed(1)},${y.toFixed(1)}`;
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        clickCount = 1;
      } else if (clickCount === 1) {
        ctx.fillStyle = "red";
        document.getElementById("goalInput").value = `${x.toFixed(1)},${y.toFixed(1)}`;
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        clickCount = 2;
      }
    });

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch("/upload-map", { method: "POST", body: formData });
      const data = await res.json();
      alert(data.message);
      window.location.reload();
    });
    async function findExternalPath() {
    const mapName = document.getElementById("externalMapSelect").value;
    const s = document.getElementById("extStart").value.split(",");
    const g = document.getElementById("extEnd").value.split(",");

    const sx = parseFloat(s[0]), sy = parseFloat(s[1]);
    const gx = parseFloat(g[0]), gy = parseFloat(g[1]);

    const url = `/external-path?map_name=${mapName}&sx=${sx}&sy=${sy}&gx=${gx}&gy=${gy}`;

    document.getElementById("externalHighlighted").src = url;
}

  </script>
  <script>
async function loadExternalMaps() {
    const res = await fetch("/");
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const select = document.getElementById("externalMapSelect");

    // Get all maps from existing dropdown in the HTML
    doc.querySelectorAll("#mapSelect option").forEach(opt => {
        if (opt.value !== "Saveetha Engineering College") {
            const newOpt = document.createElement("option");
            newOpt.value = opt.value;
            newOpt.textContent = opt.textContent;
            select.appendChild(newOpt);
        }
    });
}

// Load maps on page start
loadExternalMaps();
</script>

</body>
</html>
